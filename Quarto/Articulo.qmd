---
title: "Articulo"
author: 
  - name: "Jose Angel Govea Garcia"
  - name: "Diego Vértiz Padilla"
  - name: "Daniel Sánchez Fortiz"
  - name: "Augusto Ley Rodriguez"
format:
  html:
    toc: true
    html-math-method: katex
    embed-resources: true
    self-contained-math: true
    df-print: kable
editor: source
---

```{r}
#| echo: false
#| output: false
library(readr)
library(dplyr)
```

# Abstract

# Introducción

La calidad del aire en México constituye uno de los principales retos de salud pública, ya que la exposición crónica a contaminantes como dióxido de azufre (SO₂), óxidos de nitrógeno (NOx) y monóxido de carbono (CO) se ha vinculado con un aumento en enfermedades cardiovasculares, respiratorias y metabólicas (Secretaría de Salud, 2022; World Health Organization \[WHO\], 2021). Estos contaminantes pueden alterar biomarcadores clave, como la hemoglobina glucosilada, los lípidos en sangre o la función renal, lo que los convierte en variables fundamentales para estudiar la relación entre ambiente y salud.

El objetivo de este trabajo es implementar un modelo probabilístico que ayude a comprender cómo los factores ambientales influyen en la salud de la población mexicana, con el fin de ofrecer insumos para políticas públicas y estrategias de prevención. Dicho modelo busca integrar información sobre contaminantes atmosféricos y biomarcadores clínicos, permitiendo visualizar relaciones causales y dependencias condicionales que no siempre son evidentes con enfoques estadísticos tradicionales.

En este contexto, las redes bayesianas gaussianas (RBG) ofrecen una herramienta poderosa, pues permiten representar la estructura de dependencias entre variables continuas bajo supuestos de normalidad multivariada. Cada nodo de la red representa una variable, y las aristas describen relaciones de dependencia probabilística. Esto facilita la estimación de probabilidades conjuntas y condicionales, incluso en presencia de datos incompletos, así como la simulación de escenarios hipotéticos (Koller & Friedman, 2009). Su importancia radica en que integran el conocimiento experto con los datos empíricos, generando modelos interpretables que apoyan la toma de decisiones en salud pública y políticas ambientales (Pearl, 2009).

De esta manera, aplicar redes bayesianas gaussianas a la relación entre contaminación y salud en México no solo permite identificar qué contaminantes afectan más a ciertos biomarcadores, sino también diseñar intervenciones más focalizadas, orientadas a la prevención y al cuidado integral de la población. \# Metodología

# Metodología

## Limpieza de Datos

### Limpieza 1

### Limpieza 2

El objetivo de la segunda limpieza es incluir los datos de calidad de aire, recolectados por SEMARNAT en el 2025, con la información previamente del ENSANUT acerca de estudios de sangre de personas y sus respectivos datos demográficos. Asumiremos que esta información son estimaciones adecuadas para los contaminantes del 2022.

Los datos con los que contamos en calidad de aire son los siguientes (las 5 observaciones son ejemplo):

```{r}
#| echo: false
data_aire <- read.csv("../data_ensanut/calidad_aire_2025.csv")
head(data_aire)
```

```{r}
#| echo: false
#| output: false
datos2 <- read.csv("../data_ensanut/datos.csv")
```

Lo primero que hicimos fue determinar un tipo de fuente de datos, debido a la magnitud de estos, nos quedamos solo con los datos provenientes de fuentes fijas. También quitamos la columna llamada "Entidad", ya que incluye la misma información que la columna llamada "Entidad_federativa". La tabla actualizada la vemos de la siguiente manera:

```{r}
#| echo: false
data_aire <- data_aire[data_aire$Tipo_de_Fuente == "Fuentes fijas", ]
data_aire$Entidad <- NULL
head(data_aire)
```

```{r}
#| echo: false
#| output: false
data_aire <- data_aire[data_aire$Tipo_de_Fuente == "Fuentes fijas", ]
data_aire$Entidad <- NULL
data_aire
```

```{r}
#| echo: false
#| output: false
data_aire$Entidad_federativa <- toupper(data_aire$Entidad_federativa)
data_aire$Municipio <- toupper(data_aire$Municipio)
```

```{r}
#| echo: false
#| output: false
datos2$desc_ent <- substring(datos2$desc_ent, 4)
```

```{r}
#| echo: false
#| output: false
datos2$desc_mun <- substring(datos2$desc_mun, 5)
```

El siguiente paso fue verificar el nombre de entidad y municipio de los 2 data frames, esto con el objetivo de ver cómo relacionar ambas tablas y poder unificar la información. En el caso de la tabla aire algunos ejemplos de entidades federativas y municipios son los siguientes:

-   Aguascalientes
-   Baja California
-   Asientos
-   Pabellón de Arteaga

Mientras que esta misma información, en la tabla referente a la informacion del ensanut la visualizamos de la siguiente manera:

-   01 AGUASCALIENTES
-   02 BAJA CALIFORNIA
-   002 ASIENTOS
-   006 PABELLÓN DE ARTEAGA

Con esta información decidimos que al primer grupo de datos (SEMARNAT), tanto a las entidades y municipios las pasaríamos a un formato en mayúsculas únicamente. Mientras que en el segundo grupo de datos (ENSANUT), eliminaríamos los números y el primer espacio. Con estos cambios ambas tablas tendrían el mismo formato para sus entidades y muncipios.

Una vez realizado estos cambios realizamos un antijoin entre ambas tablas, esto con la intención de conocer qué elementos seguían sin coincidir. En el caso de las entidades no coincidían 3, para los datos acerca del aire son los siguientes:

-   COAHUILA\
-   MICHOACÁN\
-   VERACRUZ

Mientras que en el conjunto de datos del ENSANUT aparecían de la siguiente manera:

-   COAHUILA DE ZARAGOZA\
-   MICHOACÁN DE OCAMPO\
-   VERACRUZ DE IGNACIO DE LA LLAVE

```{r}
#| echo: false
#| output: false
datos2 <- datos2 %>%
  mutate(
    desc_ent = recode(
      desc_ent,
      "COAHUILA DE ZARAGOZA"       = "COAHUILA",
      "MICHOACÁN DE OCAMPO"        = "MICHOACÁN",
      "VERACRUZ DE IGNACIO DE LA LLAVE" = "VERACRUZ"
    )
  )
```

Como se puede leer, estos son exactamente los mismos estados pero pequeñas variaciones en los nombres. Debido a esto, modificamos el segundo conjunto de datos para que coincidiera con el primero

En el caso del los municipios, cuando realizamos un autojoin para conocer aquellas que no coincidía, nos percatamos que no era por variaciones en los nombres, si no porque información de un municipio en cierta tabla, no se encontraba presente en la otra, esto sucedía en ambas direcciones. En este caso no realizamos ninguna modificación.

Una vez realizados estos cambios ya se pudo realizar un inner join, para poder contar en una misma con todos los datos. Esta unión la podemos visualizar en la siguiente tabla:

```{r}
#| echo: false
#| output: false
resultado <- inner_join(datos2, data_aire, by = c("desc_ent" = "Entidad_federativa", "desc_mun" = "Municipio"))
```

```{r}
#| echo: false
head(resultado)
```

## Expertos químicos

Al tener nuestras bases de datos listas para usarse, el siguiente paso fue el comunicar nuestro objetivo y buscar la ayuda de expertos químicos. Los expertos contactados fueron: el Dr. Alberto Sánchez Estrada, ingeniero agrónomo en sistemas de producción agrícola, maestría en fruticultura y doctorado en agricultura protegida. Cuenta con gran conocimiento de el efecto de estos contaminantes en el aire; la Mtra. Judith Fortiz Hernández, ingeniera agroindustrial y maestra en ciencias agrícolas, su enfoque fue parecido al del Dr. Alberto; y por último contamos con la opinión de un experto en salud, el Dr. Víctor Zepeda Fortiz, licenciado en medicina. Para poder empezar el proceso, se desecharon las variables que no irrelevantes para el estudio, solo dejando todos los contaminantes y todos los resultados de las pruebas de salud, en estos no desechamos ninguna hasta obtener las opiniones de los expertos, junto con las variables esenciales sociodemográficas. Se colocaron en un archivo listo para que los expertos pudieran elegir las que creyeran más convenientes y pasar a la proposición de DAGs.

El Dr. Alberto propuso enfocarse en evaluar cómo la exposición a contaminantes atmosféricos se relaciona con biomarcadores sanguíneos y diferencias demográficas. En particular, sugiere:

(i) analizar si el amoníaco modula la proteína C reactiva (PCR) mediado por el perfil lipídico (colesterol y triglicéridos);

(ii) estudiar la asociación de NOx y compuestos orgánicos volátiles con los niveles de ferritina considerando estrato social, edad, sexo y residencia;

(iii) vincular sulfatos, amoníaco y óxidos nitrosos/volátiles con folatos, con especial atención a mujeres gestantes y resultados al nacer;

(iv) relacionar CO₂ con albúmina y su posible interacción con colesterol y el estado nutricional; y

(v) examinar homocisteína en sinergia con albúmina ante exposición a CO₂, nitritos, amonio y sulfatos, explorando además la sensibilidad por edad y diferencias por sexo.

El Dr. Victor propone centrar el análisis en la relación entre contaminación del aire y salud mediante biomarcadores clave y patrones de uso de servicios de salud. En particular, sugiere:

(i) priorizar la proteína C reactiva (PCR) como biomarcador principal y compararla frente a distintos contaminantes —con énfasis en PM2.5—, además de estratificar por variables sociodemográficas (entidad, edad, sexo, antecedente de COVID-19, zona de trabajo y estrato);

(ii) evaluar asociaciones específicas de contaminantes con enfermedades respiratorias, cardiovasculares y metabólicas;

(iii) explorar si vitaminas (B12 y folatos) modulan la necesidad de consulta médica;

(iv) formular preguntas guía sobre la relación entre niveles de contaminantes y elevación de PCR; y

(v) analizar qué contaminantes se vinculan más con enfermedades crónicas.

La Mtra. Judith remitió un listado estructurado de variables para el análisis de contaminación y salud. En particular, especifica:

(i) **estratificadores sociodemográficos**: entidad, municipio, sexo, edad, estrato, zona de trabajo y antecedentes (necesidad de atención médica en 3 meses y haber sido paciente COVID);

(ii) **panel de biomarcadores** para inflamación, metabolismo, función renal y micronutrientes: proteína C reactiva (PCR), ferritina, receptor soluble de transferrina (sTfR), perfil lipídico (colesterol total, HDL, LDL, triglicéridos), HbA1c, glucosa promedio estimada (EAG), insulina, creatinina, albúmina, ácido úrico, homocisteína, folato, vitaminas B12 y D;

(iii) **variables ambientales**: tipo de fuente emisora y niveles de SO₂, CO, NOx, compuestos orgánicos volátiles (COV), PM₁₀, PM₂.₅ y NH₃.

En conjunto, su aporte funciona como glosario/plantilla de variables para vincular exposición a contaminantes con biomarcadores y demanda de atención, habilitando comparaciones por edad, sexo, entidad, estrato y ocupación; no formula hipótesis explícitas, sino que sienta la base para construir preguntas de investigación y modelos estadísticos.

De manera convergente, las tres recomendaciones coinciden en la necesidad de vincular la exposición a contaminantes atmosféricos con biomarcadores sanguíneos y analizarlos bajo un marco sociodemográfico, dando a entender que las variables que les fueron comparidas sí tenían relevancia. Tanto el Dr. Alberto como el Dr. Victor subrayan la importancia de la proteína C reactiva (PCR) y otros marcadores de inflamación en relación con contaminantes como PM2.5, NOx, COV y amoníaco, mientras que la Mtra. Judith aporta un glosario estructurado que refuerza esta misma línea al incluir biomarcadores de inflamación, metabolismo y micronutrientes junto con variables ambientales y sociales. En conjunto, los tres enfoques concluyen en priorizar la PCR como indicador central, considerar múltiples contaminantes relevantes y dar peso a los factores demográficos para sustentar modelos comparativos y preguntas de investigación sólidas.

## DAGs
Para la creación de las DAGS utilizamos las variables en común de los 3 expertos, asimismo nos basamos completamente en sus opiniones. Aunque no utilizamos todas las variables de los expertos en sus DAGS ya que necesitamos hacer una comparación de las DAGS para saber cuál fue la mejor. Y así utilizarla para las queries que ellos mismos nos propusieron.

Pero antes de la creación de las DAGs hicimos una pequeña limpieza para poder quedarnos con un dataframe con solo las variables. 
Lo primero que hicimos fue seleccionar las variables de interés. Al tenerlas, eliminamos las observaciones que tuvieran algún valor faltante. Ya teniendo esto listo renombramos las columnas para tener mayor control que son las siguientes:
E = Entidad
M = Municipio
ES = Estrato
S = Sexo
C19 = COVID 19
NO = Nivel NOx
CO = Nivel de COv
SO = Nivel de S0_2
MN = Micronutrientes
C = Colesterol Total
T = Triglicéridos
F = valor de Ferritina
FO = Valor de Fol.
H = Valor de HCST
CT = Valor de Creatinina
AC = Valor de Ácido Úrico
HB = Valor de Hemoglobina Glucosilada

Después lo que hicimos fue estandarizar la variable C19, si la variable es 1,2,3,4 = 1 (si ha tenido COVID) y si la variable es 98 ,99 = 0 (no ha tenido COVID). Esto para facilitar las DAGs.
Como la mayoría de nuestras variables eran caracteres y tenían comas (,) en lugar de puntos (.). Las convertimos a numéricas y remplazamos las comas por puntos. 
Como por el momento vamos a hacer las DAGs con solo variables continuas y no categóricas o dicotómicas eliminamos las siguientes columnas (variables). E (Entidad), M (Municipio), S (Sexo), ES(Estrato) C19 (COVID) y el MN (Micronutrientes). 
Y así se ve nuestros dataframe final.


```{r}
#| echo: false
#| output: false
library(tidyverse)
library(bnlearn)
```
```{r}
#| echo: false
#| output: false
library(dplyr)
```

```{r}
#| echo: false
#| output: false
data = read_csv("../data_ensanut/datos2.csv")
head(data)
```

```{r}
#| echo: false
#| output: false
colnames(data)
```
```{r}
#| echo: false
#| output: false
vars_usar <- c("desc_ent", "desc_mun", "estrato", "h0302", "h1205", "NOx",
               "COV", "SO_2", "nota03", "valor_COLEST", "valor_TRIG",
               "valor_FERRITINA", "valor_FOL", "valor_HCST","valor_CREAT", "valor_AC_URICO", "valor_HB1AC")
```

```{r}
#| echo: false
#| output: false
datos_buenos <- data[, vars_usar]
```

```{r}
#| echo: false
#| output: false
head(datos_buenos)
```

```{r}
#| echo: false
#| output: false
datos_ <- na.omit(datos_buenos)
head(datos_)
```
```{r}
#| echo: false
#| output: false
colSums(is.na(datos_))
```
```{r}
#| echo: false
#| output: false
colnames(datos_) = c("E", "M", "ES", "S", "C19", "NO","CO", "SO", "MN", "C", "T", "F", "FO", "H", "CT", "AC", "HB")
```

```{r}
#| echo: false
#| output: false
head(datos_)
```

```{r}
#| echo: false
#| output: false
datos_ <- datos_ %>%
  mutate(C19 = case_when(
    C19 %in% c(1,2,3,4) ~ 1,   
    C19 %in% c(98,99)   ~ 0, ))
```

```{r}
#| echo: false
#| output: false
datos_ <- datos_ %>%
  mutate(CT = as.numeric(str_replace(CT, ",", "\\.")))
```

```{r}
#| echo: false
data = datos_ |>
        select(-E,-M, -C19, -MN, -ES, -S)
```

```{r}
#| echo: false
head(data)
```

Ya teniendo nuestro dataframe final creamos las 3 DAGS.

```{r}
#| echo: false
dag1 <- model2network("[NO][CO][SO][CT|NO:CO:SO][AC|NO:CO:SO:CT][HB|NO:SO][F|NO:CO:SO:HB][T|HB:AC:F][C|HB:AC:F][FO][H|NO:CO:SO:FO]")
```

DAG 1:
```{r}
#| echo: false
graphviz.plot(dag1, shape = "ellipse")
```
DAG 2: 
```{r}
#| echo: false
dag2 <- model2network("[NO][CO][SO][HB|NO:CO:SO][AC|NO:CO:SO][H|NO:CO:SO:FO][FO][F|CT][CT|NO:SO][T|HB:AC][C|HB:AC]")
```

```{r}
#| echo: false


graphviz.plot(dag2, shape = "ellipse")
```

```{r}
#| echo: false

dag3 <- model2network("[NO][CO][SO][H|NO:CO:SO:FO][FO][F|SO][CT|NO:CO:SO][AC|H:CT][HB|NO:SO][T|HB:AC][C|HB:AC]")
```


```{r}
#| echo: false
graphviz.plot(dag3, shape = "ellipse")
```

## Evaluación de las DAGs

## Variables categóricas

Un punto de interes muy fuerte en la cracion de un modelo como este es el sexo de la persona. Sin embargo, las redes bayeasianas gaussinas  solo nos permiten trabajar con variables continuas que siguen una distribución normal multivariada. Por lo que, no es posible incluir variables categoricas dentro de este marco.

### Discretización

El primer metodo consiste enuna discretizacion de todas las variables continuas, de modo que, estas variables ahora estaran representadas en un espacio discreto. Este cambio hace que pasemos de un modelo bayesiano gaussiano a un modelo bayesiano discreto. Diversos métodos han sido propuestos para elegir los puntos de corte, entre ellos estrategias simples (intervalos de igual amplitud o frecuencia) y enfoques más avanzados que incorporan la discretización dentro del propio proceso de aprendizaje de la red, buscando un equilibrio entre la complejidad del modelo y su capacidad de representar los datos (Friedman & Goldszmidt, 1996).

Este procedimiento presenta ciertas limitaciones. En primer lugar, implica una pérdida de información, ya que se reducen valores continuos a categorías. Además, una discretización inadecuada puede llevar a modelos poco generalizables o que no reflejen adecuadamente las relaciones entre variables.

### Modelos mixtos/hibridos

El segundo enfoque corresponde a las redes bayesianas gaussinas condicionales (CGBN), también llamadas redes híbridas. En este marco, las variables categóricas se incluyen como nodos que condicionan la distribución de las variables continuas. Esto significa que cada categoría de una variable discreta define una distribución gaussiana distinta sobre las variables continuas relacionadas. Este enfoque permite modelar de manera más fiel la interacción entre categorías y mediciones numéricas, evitando la necesidad de discretizar los datos originales (Lauritzen & Wermuth, 1989). No obstante, su implementación es más compleja

### Implementación

En la implementación con el paquete bnlearn en R nos encontramos con una limitacion importante. No es posible combinar variables categóricas y continuas en una misma red. Este nos exige que los datos sean homogéneos, es decir, que todas las variables sean discretas o que todas sean continuas. Esto impide la construcción de redes híbridas dentro de este entorno, incluso si se recodifican las variables categóricas. En el trabajo realizado se intentó incluir variables como el sexo y el estrato social en una red bayesiana gaussiana, pero el modelo rechazó estas variables al no cumplir con los supuestos previamente mencionaods.

# Aplicación

# Conclusiones

# Referencias

Koller, D., & Friedman, N. (2009). Probabilistic Graphical Models: Principles and Techniques. MIT Press.

Pearl, J. (2009). Causality: Models, Reasoning and Inference (2nd ed.). Cambridge University Press.

Secretaría de Salud. (2022). Informe sobre la calidad del aire y salud en México. Gobierno de México.

World Health Organization. (2021). Air pollution. https://www.who.int/health-topics/air-pollution

Friedman, N., & Goldszmidt, M. (1996). Discretizing Continuous Attributes While Learning Bayesian Networks. Proceedings of the Thirteenth International Conference on Machine Learning. Recuperado de  https://www.cs.huji.ac.il/w~nir/Papers/FrG2.pdf

Lauritzen, S. L., & Wermuth, N. (1989). Graphical models for associations between variables, some of which are qualitative and some quantitative. The Annals of Statistics.

